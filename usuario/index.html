<!DOCTYPE html>
<html lang="es">
    <head>
      <meta charset="utf-8">
      <title>Usuario</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <link rel="icon" type="image/png" href="/images/favicon.png">
      <!-- CSS -->
      <link rel="stylesheet" href="/assets/css/bootstrap.css" media="screen">
      <link rel="stylesheet" href="/assets/css/custom.min.css">
      <link rel="stylesheet" href="/assets/css/fontawesome.css">
      <!-- necesita /webfonts -->
      <link rel="stylesheet" href="/assets/css/loading.css" media="all" type="text/css" />
      <link rel="stylesheet" href="/assets/css/alertify.min.css" />
      <link rel="stylesheet" href="/assets/css/alertify-default.min.css" />
      <link rel="stylesheet" href="/assets/css/alertify-semantic.min.css" />
    
      <!-- JavaScript -->
      <script src="/assets/js/main.js"></script>
      <script src="/assets/js/jquery.min.js"></script>
      <script src="/assets/js/popper.min.js"></script>
      <script src="/assets/js/bootstrap.min.js"></script>
      <script src="/assets/js/custom.js"></script>
      <script src="/assets/js/alertify.min.js"></script>
      <script src="/assets/js/jquery.twbsPagination.min.js"></script>
      <script src="/assets/js/vue.js"></script>
      <!--<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>-->
    </head>
    
    <body>
      <div id="app">
        <div id="loading" v-if="loading">
          <div class="location_indicator"><img src="/images/logo.jpg" alt=""></div>
        </div>
    
        <nav class="navbar navbar-expand-lg fixed-top navbar-dark bg-primary">
          <a class="navbar-brand d-none d-lg-block d-xl-block" href="#">
            <img src="/images/logo.jpg" width="40px" class="img-responsive img-circle" alt="logo image">
          </a>
    
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
    
          <a v-if="login" class="navbar-brand d-block d-lg-none d-xl-none" href="#">
            <img src="/images/logo.jpg" width="40px" class="img-responsive img-circle" alt="logo image">
          </a>
    
          <div v-if="!login" class="d-block d-lg-none d-xl-none">
            <div style="color: #fff;" class="dropdown-toggle mr-md-2" id="bd-versions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <img src="/images/default_avatar_male.jpg" width="40px" class="img-responsive img-circle" alt="profile image"> {{nombreUsuario}}
            </div>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-versions">
              <a class="dropdown-item" href="/mi_perfil">Mi Perfil</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" @click="cerrarSesion()">Cerrar Sesión</a>
            </div>
          </div>
    
          <div class="collapse navbar-collapse" id="navbarColor01">
            <ul class="navbar-nav mr-auto" v-if="funcionalidades.length > 0">
              <template v-for="funcionalidad in funcionalidades">
                <li class="nav-item active" v-if="urlActual == funcionalidad.url">
                  <a class="nav-link" :href="funcionalidad.url">{{funcionalidad.descripcion}}</a>
                </li>
                <li class="nav-item" v-else>
                  <a class="nav-link" :href="funcionalidad.url">{{funcionalidad.descripcion}}</a>
                </li>
              </template>
              <li class="nav-item">
                  <a class="nav-link" href="#"  @click="cerrarSesion()">Cerrar Sesión</a>
              </li>
            </ul>
            <template v-if="login">
              <button 
                style="margin-left:3px;"
                class="btn btn-secondary btn-sm"  
                type="button" class="btn btn-primary" 
                data-toggle="modal" 
                data-target="#modalLogin">
                Iniciar Sesión
              </button>
            </template>
            <template v-else>
              <a class="navbar-brand d-none d-lg-block d-xl-block" href="/mi_perfil" title="Ir a mi perfil" data-original-title="Tooltip on bottom">
                <img src="/images/default_avatar_male.jpg" width="40px" class="img-responsive img-circle" alt="profile image">
              </a>
              
              <ul class="navbar-nav flex-row ml-md-auto " style="margin-left: 2px !important;">
                <li class="nav-item dropdown d-none d-lg-block d-xl-block">
                  <a class="nav-item nav-link dropdown-toggle mr-md-2" href="#" id="bd-versions" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    {{nombreUsuario}}
                  </a>
                  <div class="dropdown-menu dropdown-menu-right" aria-labelledby="bd-versions">
                    <a class="dropdown-item" href="/mi_perfil">Mi Perfil</a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="#" @click="cerrarSesion()">Cerrar Sesión</a>
                  </div>
                </li>
              </ul>
            </template>
          </div>
        </nav>
    
        <div class="container" style="margin-top:80px;margin-bottom:100px">
            <div class="frm-pred">
                <div class="form-horizontal">
                  <legend class="text-center header">Usuario</legend>
                  <!--//panel-->
                  <div class="card">
                    <div class="card-header">
                      <div class="row">
                        <div class="col-8">
                          <input type="text" class="form-control" placeholder="Texto de búsqueda" v-model.trim="textoBusqueda" @keyup="listarUsuarios()" autocomplete="off">
                        </div>
                        <div class="col-4 text-right">
                          <button type="button" class="btn btn-sm btn-primary btn-create" @click="abrirModal(1)">Nuevo</button>
                        </div>
                      </div>
                    </div>
                  <div class="card-body">
                    <table class="table table-striped table-bordered table-list">
                      <thead>
                        <tr>
                            <th>Nombre</th>
                            <th class="d-none d-md-block">Documento</th>
                            <th><em class="fa fa-cog"></em></th>
                        </tr> 
                      </thead>
                      <tbody v-if="usuarios.length>0">
                        <template v-for="(usuario,index) in usuarios">
                          <tr :class="'grupag'+Math.ceil((index+1)/10)+' grupag'">
                              <td align="center">{{usuario.nombre}}</td>
                              <td align="center" class="d-none d-md-block">{{usuario.documento}}</td>
                              <td align="center">
                                <a class="btn btn-warning" @click="abrirModal(2,usuario.id)"><em class="fa fa-pencil-alt"></em></a>
                                <a class="btn btn-danger" @click="abrirModal(3,usuario.id)"><em class="fa fa-trash"></em></a>
                                <a class="btn btn-primary" @click="abrirModal(4,usuario.id)"><em class="fa fa-chevron-down"></em></a>
                              </td>
                          </tr>
                        </template>
                      </tbody>
                      <tbody v-else>
                        <tr>
                          <td colspan=3 align="center">No hay registros para mostrar</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="card-footer text-right" v-if="usuarios.length>10">
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm" id="pagination" style="margin-bottom: 0px;"></ul>
                    </nav>
                  </div>
                </div>  
                  <!--//fin panel-->
              </div>
            </div>
        </div>
        
    
        <div v-html="footer" class="container" style="background-color: #eee; max-width: 100%;">
    
        </div>
        
        <!-- Modal crud-->
        <div class="modal fade" id="modalUsuario" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="lblRegi">Registrar</h5>
                <h5 class="modal-title" id="lblModi">Modificar</h5>
                <h5 class="modal-title" id="lblElim">Eliminar</h5>
                <h5 class="modal-title" id="lblAsig">Asignar curso</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <p><b class="ocultar oculto">*</b> Campos requeridos</p>
                  
                  <div class="form-group">
                    <label for="txtNombres">Nombres *</label>
                    <input class="form-control" id="txtNombres" v-model.trim="usuario.nombres" placeholder="Escriba los nombres" autocomplete="off">
                  </div>
                  
                  <div class="form-group">
                    <label for="txtApellidos">Apellidos *</label>
                    <input class="form-control" id="txtApellidos" v-model.trim="usuario.apellidos" placeholder="Escriba los Apellidos" autocomplete="off">
                  </div>
                  
                  <div class="form-group">
                    <label for="txtTipoDocumento">Tipo Documento *</label>
                    <select class="form-control" id="txtTipoDocumento" v-model.trim="usuario.tipoDocumento">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="tipoDocumento in tipoDocumentos">
                        <option :value="tipoDocumento.id">{{tipoDocumento.descripcion}}</option>
                      </template>
                    </select>
                  </div> 
                  
                  <div class="form-group">
                    <label for="txtDocumento">Documento *</label>
                    <input class="form-control" id="txtDocumento" v-model.trim="usuario.documento" placeholder="Escriba un numero de documento" autocomplete="off">
                  </div>
                  
                  <div class="form-group oculto">
                    <label for="txtCodigo">Código</label>
                    <input class="form-control" id="txtCodigo" v-model.trim="usuario.codigo" placeholder="Escriba un código" autocomplete="off">
                  </div>
                  
                  <div class="form-group oculto">
                    <label for="txtCorreo">Correo</label>
                    <input type="text" class="form-control" id="txtCorreo" v-model.trim="usuario.correo" placeholder="Escriba un correo" autocomplete="off">
                  </div>
                  
                  <div class="form-group ocultar oculto">
                    <label for="txtClave">Clave</label>
                    <input type="password" class="form-control" id="txtClave" v-model.trim="usuario.clave" placeholder="Escriba una clave" autocomplete="off">
                    <small>dejar en blanco si el usuario no requiere iniciar sesión en el sistema o no requiere cambio de clave</small>
                  </div>
                  
                  <div class="form-group oculto">
                    <label for="txtTelefono">Teléfono</label>
                    <input type="text" class="form-control" id="txtTelefono" v-model.trim="usuario.telefono" placeholder="Escriba un teléfono" autocomplete="off">
                  </div>
                    
                  <div class="form-group" v-if="anioLectivos.length>0">
                    <label for="txtAnioLectivo">Año Lectivo</label>
                    <select class="form-control" id="txtAnioLectivo" v-model.trim="usuario.anioLectivo" @change="buscarCurso()">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="anioLectivo in anioLectivos">
                        <option :value="anioLectivo.id">{{anioLectivo.descripcion}}</option>
                      </template>
                    </select>
                  </div>
                  
                  <div class="form-group" v-if="sedes.length>0">
                    <label for="txtSede">Sede</label>
                    <select class="form-control" id="txtSede" v-model.trim="usuario.sede" @change="listarJornadas()">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="sede in sedes">
                        <option :value="sede.id">{{sede.descripcion}}</option>
                      </template>
                    </select>
                  </div>
                  
                  <div class="form-group" v-if="jornadas.length>0">
                    <label for="txtJornada">Jornada</label>
                    <select class="form-control" id="txtJornada" v-model.trim="usuario.jornada" @change="listarGrados()">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="jornada in jornadas">
                        <option :value="jornada.id">{{jornada.descripcion}}</option>
                      </template>
                    </select>
                  </div>
                  
                  <div class="form-group" v-if="grados.length>0">
                    <label for="txtGrado">Grado</label>
                    <select class="form-control" id="txtGrado" v-model.trim="usuario.grado" @change="listarCursos()">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="grado in grados">
                        <option :value="grado.id">{{grado.descripcion}}</option>
                      </template>
                    </select>
                  </div>
                  
                  <div class="form-group" v-if="cursos.length>0">
                    <label for="txtCurso">Curso</label>
                    <select class="form-control" id="txtCurso" v-model.trim="usuario.curso">
                      <option value="" selected hidden>Seleccione</option>
                      <template v-for="curso in cursos">
                        <option :value="curso.id">{{curso.descripcion}}</option>
                      </template>
                    </select>
                  </div>
                  
                  <div class="form-group" v-if="cursos.length>0&&usuario.curso!=''">
                    <label><input type="checkbox" v-model="usuario.guardarCurso">Usar las presentes opciones en los futuros registros</label>    
                  </div>
                  
                  <div class="ocultar">
                    <div class="form-group" v-if="roles.length>0">
                      <label>Roles *</label>
                      <div class="card">
                        <id class="col-sm-7" style="padding: 0px 50px 0px 50px;margin-left:auto;margin-right:auto">
                          <template v-for="rol in roles">
                            <label v-if="rol.esta==0"><input type="checkbox" :value="rol.id" name="txtroles" checked>{{rol.descripcion}}</label>
                            <label v-else><input type="checkbox" :value="rol.id" name="txtroles">{{rol.descripcion}}</label>
                            <br>
                          </template>
                        </id>
                      </div>
                      <small>Marque los roles que seran asignados al usuario</small>
                    </div>
                  </div>
                  
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary btn-sm" @click="registrar()" id="btnRegi">Registrar</button>
                <button type="button" class="btn btn-primary btn-sm" @click="modificar()" id="btnModi">Modificar</button>
                <button type="button" class="btn btn-primary btn-sm" @click="eliminar()" id="btnElim">Eliminar</button>
                <button type="button" class="btn btn-primary btn-sm" @click="asignar()" id="btnAsig">Asignar</button>
              </div>
            </div>
          </div>
        </div>
        <!--fin modal-->
      </div>
      <!-- fin #app -->
      <script>
        var app = new Vue({
          el: '#app',
          data: {
            urlActual: '/usuario',
            login: true,
            loading: true,
            nombreUsuario: '',
            asignarCurso:false,
            anioLectivos: [],
            sedes: [],
            jornadas:[],
            grados:[],
            cursos:[],
            funcionalidades: [],
            usuarios:[],
            tipoDocumentos:[],
            textoBusqueda:'',
            sedes:[],
            roles:[],
            usuario:{
              id:'',
              nombres:'',
              apellidos:'',
              tipoDocumento:'',
              anioLectivo:'',
              documento:'',
              codigo:'',
              correo:'',
              clave:'',
              telefono:'',
              curso:'',
              sede:'',
              grado:'',
              jornada:'',
              roles:[],
              guardarCurso:false
            },
            footer: '<p>footer</p>'
          },
          created: function() {
            this.listarFuncionalidades()
            this.listarUsuarios()
          },
          methods: {
            cerrarSesion: function() {
              var self = this
              self.loading = true
              var frm = {}
              $.post(url_servidor + "/usuario/logout.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.listarFuncionalidades()
                }
              }, "json");
            },
            listarFuncionalidades: function() {
              var self = this
              var frm = {urlActual:self.urlActual}
              self.loading = true
              $.post(url_servidor+"/funcionalidad/listar.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.funcionalidades = data.funcionalidades
                  self.nombreUsuario = data.nombreUsuario
                  self.login = data.login
                  self.footer = data.footer
                  self.loading = false;
                }
                else {
                  location.href="/";
                }
              }, "json");
            },
            listarUsuarios: function() {
              var self = this
              var frm = {
                textoBusqueda : self.textoBusqueda
              }
              $.post(url_servidor+"/usuario/listar.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.usuarios = data.usuarios
                  if(self.usuarios.length>10){
                    $(function () {
                      $('#pagination').twbsPagination('destroy');
                      window.pagObj = $('#pagination').twbsPagination({
                          totalPages: Math.ceil(self.usuarios.length/10),
                          visiblePages: 5,
                          onPageClick: function (event, page) {
                            $(".grupag").slideUp(0);
                            $(".grupag"+page).slideDown(0);    
                          }
                      }).on('page', function (event, page) {
                      });
                    });
                  }
                }
                else {
                  self.usuarios = data.usuarios
                }
              }, "json");
            },
            listarTipoDocumento: function() {
              var self = this
              var frm = "";
              $.post(url_servidor+"/tipo_documento/listar.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.tipoDocumentos = data.tipoDocumentos
                }
                else {
                  self.tipoDocumentos = data.tipoDocumentos
                  alertify.error("Error al cargar tipos de documento")
                }
              }, "json");
            },
            abrirModal: function(to,id) {
              var self = this;
              self.usuario.id="";
              self.usuario.nombres="";
              self.usuario.apellidos="";
              self.usuario.tipoDocumento="";
              self.usuario.documento="";
              self.usuario.codigo="";
              self.usuario.correo="";
              self.usuario.clave="";
              self.usuario.telefono="";
              if(!self.usuario.guardarCurso){
                self.usuario.anioLectivo="";
                self.usuario.sede="";
                self.usuario.jornada="";
                self.usuario.grado="";
                self.usuario.curso="";  
              }
              self.usuario.roles=[];
              self.anioLectivos = [];
              self.jornadas = [];
              self.grados = [];
              self.cursos = [];
              self.sedes = [];
              self.roles = [];
              self.tipoDocumentos = [];
              if(to==1){
                $("#btnRegi").slideDown(0);
                $("#btnModi").slideUp(0);
                $("#btnElim").slideUp(0);
                $("#btnAsig").slideUp(0);
                $("#lblRegi").slideDown(0);
                $("#lblModi").slideUp(0);
                $("#lblElim").slideUp(0);
                $("#lblAsig").slideUp(0);
                $(".ocultar").slideDown(0);
                $(".oculto").slideDown(0);
                
                $("#txtNombres").prop("disabled",false);
                $("#txtApellidos").prop("disabled",false);
                $("#txtDocumento").prop("disabled",false);
                $("#txtTipoDocumento").prop("disabled",false);
                $("#txtCodigo").prop("disabled",false);
                $("#txtCorreo").prop("disabled",false);
                $("#txtClave").prop("disabled",false);
                $("#txtTelefono").prop("disabled",false);
                self.listarRoles();
                self.listarTipoDocumento();
                
                $("#modalUsuario").modal("show");
              }
              else
              if(to==2){
                
                $("#btnRegi").slideUp(0);
                $("#btnModi").slideDown(0);
                $("#btnElim").slideUp(0);
                $("#btnAsig").slideUp(0);
                
                $("#lblRegi").slideUp(0);
                $("#lblModi").slideDown(0);
                $("#lblElim").slideUp(0);
                $("#lblAsig").slideUp(0);
                $(".ocultar").slideDown(0);
                $(".oculto").slideDown(0);
                
                $("#txtNombres").prop("disabled",false);
                $("#txtApellidos").prop("disabled",false);
                $("#txtDocumento").prop("disabled",false);
                $("#txtTipoDocumento").prop("disabled",false);
                $("#txtCodigo").prop("disabled",false);
                $("#txtCorreo").prop("disabled",false);
                $("#txtClave").prop("disabled",false);
                $("#txtTelefono").prop("disabled",false);
                
                self.listarTipoDocumento();
                self.buscar(id);
                
              }
              else
              if(to==3){
                
                $("#btnRegi").slideUp(0);
                $("#btnModi").slideUp(0);
                $("#btnElim").slideDown(0);
                $("#btnAsig").slideUp(0);
                
                $("#lblRegi").slideUp(0);
                $("#lblModi").slideUp(0);
                $("#lblElim").slideDown(0);
                $("#lblAsig").slideUp(0);
                $(".ocultar").slideUp(0);
                $(".oculto").slideDown(0);
                
                
                $("#txtNombres").prop("disabled",true);
                $("#txtApellidos").prop("disabled",true);
                $("#txtDocumento").prop("disabled",true);
                $("#txtCodigo").prop("disabled",true);
                $("#txtCorreo").prop("disabled",true);
                $("#txtClave").prop("disabled",true);
                $("#txtTelefono").prop("disabled",true);
                $("#txtTipoDocumento").prop("disabled",true);
                
                self.listarTipoDocumento();
                self.buscar(id);
                
              }
              else
              if(to==4){
                $("#btnRegi").slideUp(0);
                $("#btnModi").slideUp(0);
                $("#btnElim").slideUp(0);
                $("#btnAsig").slideDown(0);
                $("#lblRegi").slideUp(0);
                $("#lblModi").slideUp(0);
                $("#lblElim").slideUp(0);
                $("#lblAsig").slideDown(0);
                $(".ocultar").slideUp(0);
                $(".oculto").slideUp(0);
                
                $("#txtNombres").prop("disabled",true);
                $("#txtApellidos").prop("disabled",true);
                $("#txtDocumento").prop("disabled",true);
                $("#txtTipoDocumento").prop("disabled",true);
                self.listarTipoDocumento();
                self.listarSedes();
                self.buscar(id,4);
                self.usuario.guardarCurso=false;
              }
            },
            buscar: function(id,to) {
              var self=this;
              var frm = {
                id:id
              }
              $.post(url_servidor+"/usuario/buscar.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.usuario.id = data.usuario[0].id;
                  self.usuario.nombres = data.usuario[0].nombres;
                  self.usuario.apellidos = data.usuario[0].apellidos;
                  self.usuario.tipoDocumento = data.usuario[0].tipoDocumento;
                  self.usuario.documento = data.usuario[0].documento;
                  self.usuario.codigo = data.usuario[0].codigo;
                  self.usuario.correo = data.usuario[0].correo;
                  self.usuario.telefono = data.usuario[0].telefono;
                  self.listarRoles();
                  if(to==4){
                    self.listarAnioLectivos(4);  
                  }
                  $("#modalUsuario").modal("show");
                }
                else {
                  alertify.error(data.mensaje);
                }
              }, "json");  
            },
            listarAnioLectivos: function(to) {
              var self = this
              var frm = "";
              $.post(url_servidor+"/anio_lectivo/listar.php", frm, function(data) {
                console.log(data)
                if (data.estado == "OK") {
                  self.anioLectivos = data.anioLectivos
                  if(data.anioActual!=""){
                    self.usuario.anioLectivo = data.anioActual;
                    if(to==4){
                      self.buscarCurso();
                    }
                  }
                }
                else {
                  self.anioLectivos = data.anioLectivos
                }
              }, "json");
            },
            listarSedes: function() {
              var self = this
              var frm = "";
              $.post(url_servidor+"/sede/listar.php", frm, function(data) {
                if (data.estado == "OK") {
                  self.sedes = data.sedes
                }
                else {
                  self.sedes = data.sedes
                }
              }, "json");
            },
            listarJornadas: function() {
              var self = this
              var frm = {
                idSede:self.usuario.sede,
                idAnio:self.usuario.anioLectivo
              }
              if(frm.idSede!=""&&frm.idAnio!=""){
                self.usuario.jornada="";
                self.usuario.grado="";
                self.usuario.curso="";
                self.jornadas = [];
                self.grados = [];
                self.cursos = [];
                $.post(url_servidor+"/jornada/listarPorAnio.php", frm, function(data) {
                  if (data.estado == "OK") {
                    self.jornadas = data.jornadas
                  }
                  else {
                    self.jornadas = data.jornadas
                    alertify.error(data.mensaje)
                  }
                }, "json");
              }
            },
            listarGrados: function() {
              var self = this
              var frm = {
                idJornada:self.usuario.jornada,
                idAnio:self.usuario.anioLectivo,
                idSede:self.usuario.sede
              }
              if(frm.idSede!=""&&frm.idJornada!=""&&frm.idSede!=""){
                self.usuario.grado="";
                self.usuario.curso="";
                self.grados = [];
                self.cursos = [];
                $.post(url_servidor+"/grado/listarPorAnio.php", frm, function(data) {
                  if (data.estado == "OK") {
                    self.grados = data.grados
                  }
                  else {
                    self.grados = data.grados
                    alertify.error(data.mensaje)
                  }
                }, "json");
              }
            },
            listarCursos: function() {
              var self = this
              var frm = {
                idGrado:self.usuario.grado,
                idAnio:self.usuario.anioLectivo,
                idSede:self.usuario.sede,
                idJornada:self.usuario.jornada
              }
              if(frm.idSede!=""&&frm.idJornada!=""){
                console.log(frm)
                self.usuario.curso = "";
                self.cursos = [];
                $.post(url_servidor+"/curso/listarPorAnio.php", frm, function(data) {
                  if (data.estado == "OK") {
                    self.cursos = data.cursos
                  }
                  else {
                    self.cursos = data.cursos
                    alertify.error(data.mensaje)
                  }
                }, "json");
              }
            },
            listarRoles: function() {
              var self = this
              var frm = {
                idUsua : self.usuario.id
              }
              $.post(url_servidor+"/usuario/listarRoles.php", frm, function(data) {
                if (data.estado == "OK") {
                  console.log(data)
                  self.roles = []
                  self.roles = data.roles
                }
                else {
                  self.roles = data.roles
                }
              }, "json");
            },
            registrar: function(){
              var self=this;
              self.usuario.roles=[];
              $('input[name="txtroles"]:checked').each(function() {
                self.usuario.roles.push(this.value);
              });
              var frm = self.usuario;
              if(frm.nombres==""){
                alertify.error("Escriba al menos un nombre");
              }else
              if(frm.apellidos==""){
                alertify.error("Escriba al menos un apellido");
              }else
              if(frm.tipoDocumento==""){
                alertify.error("Seleccione un tipo de documento");
              }else
              if(frm.documento==""){
                alertify.error("Escriba un documento");
              }else
              if(frm.roles.length==0){
                alertify.error("Seleccione al menos un rol");
              }else{
                alertify.confirm('Confirmar', '¿Desea registrar este usuario?',
                  function(){
                    console.log(self.usuario)
                    alertify.confirm().close();
                    $("#btnRegi").prop("disabled",true);
                    $("#btnRegi").text("Registrando...");
                    $.post(url_servidor+"/usuario/gestionar.php", frm, function(data) {
                      if (data.estado == "OK") {
                        console.log(data);
                        alertify.success(data.mensaje)
                        $("#modalUsuario").modal('hide')
                        self.listarUsuarios();
                        $("#btnRegi").prop("disabled",false);
                        $("#btnRegi").text("Registrar");
                      }
                      else {
                        alertify.error(data.mensaje)
                        $("#btnRegi").prop("disabled",false);
                        $("#btnRegi").text("Registrar");
                      }
                    }, "json");
                  },
                  function(){
                    alertify.confirm().close();
                  }
                ).set('labels', {ok:'Aceptar', cancel:'Cancelar'});
              }
            },
            modificar: function(){
              var self=this;
              self.usuario.roles=[];
              $('input[name="txtroles"]:checked').each(function() {
                self.usuario.roles.push(this.value);
              });
              var frm = self.usuario;
              if(frm.nombres==""){
                alertify.error("Escriba al menos un nombre");
              }else
              if(frm.apellidos==""){
                alertify.error("Escriba al menos un apellido");
              }else
              if(frm.tipoDocumento==""){
                alertify.error("Seleccione un tipo de documento");
              }else
              if(frm.documento==""){
                alertify.error("Escriba un documento");
              }else
              if(frm.roles.length==0){
                alertify.error("Seleccione al menos un rol");
              }else{
                alertify.confirm('Confirmar', '¿Desea modificar este usuario?',
                  function(){
                    alertify.confirm().close();
                    $("#btnModi").prop("disabled",true);
                    $("#btnModi").text("Modificando...");
                    $.post(url_servidor+"/usuario/gestionar.php", frm, function(data) {
                      if (data.estado == "OK") {
                        alertify.success(data.mensaje)
                        $("#modalUsuario").modal('hide')
                        self.listarUsuarios();
                        $("#btnModi").prop("disabled",false);
                        $("#btnModi").text("Modificar");
                      }
                      else {
                        alertify.error(data.mensaje)
                        $("#btnModi").prop("disabled",false);
                        $("#btnModi").text("Modificar");
                      }
                    }, "json");
                  },
                  function(){
                    alertify.confirm().close();
                  }
                ).set('labels', {ok:'Aceptar', cancel:'Cancelar'});
              }
            },
            eliminar: function(){
              var self=this;
              var frm = self.usuario;
              alertify.confirm('Confirmar', '¿Desea eliminar este usuario?',
                function(){
                  alertify.confirm().close();
                  $("#btnElim").prop("disabled",true);
                  $("#btnElim").text("Eliminando...");
                  $.post(url_servidor+"/usuario/eliminar.php", frm, function(data) {
                    if (data.estado == "OK") {
                      alertify.success(data.mensaje) 
                      $("#modalUsuario").modal('hide')
                      self.listarUsuarios();
                      $("#btnElim").prop("disabled",false);
                      $("#btnElim").text("Eliminar");
                    }
                    else {
                      alertify.error(data.mensaje) 
                      $("#btnElim").prop("disabled",false);
                      $("#btnElim").text("Eliminar");
                    }
                  }, "json");
                },
                function(){
                  alertify.confirm().close();
                }
              ).set('labels', {ok:'Aceptar', cancel:'Cancelar'});
            },
            asignar: function(){
              var self=this;
              var frm = {
                idUsua: self.usuario.id,
                idSede:self.usuario.sede,
                idJornada:self.usuario.jornada,
                idAnio:self.usuario.anioLectivo,
                idGrado:self.usuario.grado,
                idCurso:self.usuario.curso
              };
              if(frm.idAnio==""){
                alertify.error("Seleccione un año lectivo");
              }
              else
              if(frm.idSede==""){
                alertify.error("Seleccione una sede");
              }
              else
              if(frm.idJornada==""){
                alertify.error("Seleccione una jornada");
              }
              else
              if(frm.idGrado==""){
                alertify.error("Seleccione un grado");
              }
              else
              if(frm.idCurso==""){
                alertify.error("Seleccione un curso");
              }
              else{
                alertify.confirm('Confirmar', '¿Desea asignar este curso?',
                  function(){
                    alertify.confirm().close();
                    $("#btnAsig").prop("disabled",true);
                    $("#btnAsig").text("Asignando...");
                    $.post(url_servidor+"/usuario/asignar.php", frm, function(data) {
                      if (data.estado == "OK") {
                        alertify.success(data.mensaje) 
                        $("#modalUsuario").modal('hide')
                        self.listarUsuarios();
                        $("#btnAsig").prop("disabled",false);
                        $("#btnAsig").text("Asignar");
                      }
                      else {
                        alertify.error(data.mensaje) 
                        $("#btnAsig").prop("disabled",false);
                        $("#btnAsig").text("Asignar");
                      }
                    }, "json");
                  },
                  function(){
                    alertify.confirm().close();
                  }
                ).set('labels', {ok:'Aceptar', cancel:'Cancelar'});
              }
            },
            buscarCurso: function(){
              var self=this;
              var frm = {
                idUsua:self.usuario.id,
                idAnio:self.usuario.anioLectivo
              }
              $.post(url_servidor+"/usuario/buscarCurso.php", frm, function(data) {
                if (data.curso.length>0){
                  self.usuario.sede = data.curso[0].sede;
                  self.listarJornadas();
                  self.usuario.jornada = data.curso[0].jornada;
                  self.listarGrados();
                  self.usuario.grado = data.curso[0].grado;
                  self.listarCursos();
                  self.usuario.curso = data.curso[0].curso;
                }
              }, "json");  
            }
          }
        })
      </script>
    </body>
</html>
